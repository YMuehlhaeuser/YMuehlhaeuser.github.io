---
import { getCollection } from 'astro:content';
import { Image, getImage } from 'astro:assets';

const allPhotos = await getCollection('photos');

// Sort by date descending
const photos = allPhotos.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Pre-process images to get dimensions for PhotoSwipe
const processedPhotos = await Promise.all(
  photos.map(async (photo) => {
    const optimized = await getImage({ src: photo.data.src, format: 'webp' });
    return {
      ...photo,
      optimizedSrc: optimized.src,
      width: optimized.attributes.width,
      height: optimized.attributes.height,
    };
  })
);
---

{processedPhotos.length === 0 ? (
  <p class="empty">No photos yet. Add some to <code>src/content/photos/</code>!</p>
) : (
  <div class="gallery" id="gallery">
    {processedPhotos.map((photo) => (
      <a
        href={photo.optimizedSrc}
        data-pswp-width={photo.width}
        data-pswp-height={photo.height}
        target="_blank"
        rel="noreferrer"
        class="gallery-item"
        title={photo.data.title}
      >
        <Image
          src={photo.data.src}
          alt={photo.data.alt}
          width={600}
          quality={80}
          format="webp"
        />
        <span class="caption">{photo.data.title}</span>
      </a>
    ))}
  </div>
)}

<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox';
  import 'photoswipe/style.css';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#gallery',
    children: 'a',
    pswpModule: () => import('photoswipe'),
  });

  lightbox.init();
</script>

<style>
  .gallery {
    columns: 3;
    column-gap: 1rem;
  }

  @media (max-width: 768px) {
    .gallery {
      columns: 2;
    }
  }

  @media (max-width: 480px) {
    .gallery {
      columns: 1;
    }
  }

  .gallery-item {
    display: block;
    break-inside: avoid;
    margin-bottom: 1rem;
    position: relative;
    overflow: hidden;
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;
  }

  .gallery-item img {
    width: 100%;
    height: auto;
    border-radius: 6px;
    transition: transform 0.2s ease;
  }

  .gallery-item:hover img {
    transform: scale(1.02);
  }

  .caption {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.5rem 0.75rem;
    background: linear-gradient(transparent, rgba(0,0,0,0.6));
    color: #fff;
    font-size: 0.8rem;
    opacity: 0;
    transition: opacity 0.2s ease;
    border-radius: 0 0 6px 6px;
  }

  .gallery-item:hover .caption {
    opacity: 1;
  }

  .empty {
    color: var(--text-muted);
    font-style: italic;
  }
</style>
