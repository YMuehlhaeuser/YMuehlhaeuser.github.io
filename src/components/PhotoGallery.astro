---
import { Image, getImage } from 'astro:assets';

interface Props {
  album?: string;
}

const { album } = Astro.props;

// Auto-discover all photos from album subfolders
const allImages = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/photos/**/*.{jpg,jpeg,png,webp,JPG,JPEG,PNG,WEBP}',
  { eager: true }
);

// Optional sidecar metadata: src/content/photos/album/filename.md
// frontmatter: title, alt, description (all optional)
const sidecars = import.meta.glob<{ frontmatter: Record<string, string> }>(
  '/src/content/photos/**/*.md',
  { eager: true }
);

// Build a lookup: "landscape/DSC00122.jpg" â†’ frontmatter
const meta: Record<string, Record<string, string>> = {};
for (const [path, mod] of Object.entries(sidecars)) {
  // path like /src/content/photos/landscape/DSC00122.md
  const parts = path.split('/');
  const albumFolder = parts.at(-2)!;
  const base = parts.at(-1)!.replace(/\.mdx?$/, '');
  meta[`${albumFolder}/${base}`] = mod.frontmatter ?? {};
}

// Filter by album
const filtered = Object.entries(allImages).filter(([path]) => {
  if (!album) return true;
  const folder = path.split('/').at(-2)!;
  return folder.toLowerCase() === album.toLowerCase();
});

// Build photo objects with optional sidecar metadata
const photos = await Promise.all(
  filtered.map(async ([path, mod]) => {
    const parts = path.split('/');
    const filename = parts.at(-1)!;
    const albumFolder = parts.at(-2)!;
    const base = filename.replace(/\.[^.]+$/, '');
    const sidecar = meta[`${albumFolder}/${base}`] ?? {};

    const title = sidecar.title ?? base.replace(/[-_]/g, ' ');
    const alt = sidecar.alt ?? title;

    const fullRes = await getImage({ src: mod.default, format: 'webp', quality: 90 });
    return { image: mod.default, title, alt, fullRes };
  })
);
---

{photos.length === 0 ? (
  <p class="empty">
    No photos yet. Drop images into <code>src/assets/photos/{album ?? 'album-name'}/</code>.
  </p>
) : (
  <div class="gallery" id="gallery">
    {photos.map((photo) => (
      <a
        href={photo.fullRes.src}
        data-pswp-width={photo.fullRes.attributes.width}
        data-pswp-height={photo.fullRes.attributes.height}
        target="_blank"
        rel="noreferrer"
        class="gallery-item"
        title={photo.title}
      >
        <Image
          src={photo.image}
          alt={photo.alt}
          width={600}
          quality={75}
          format="webp"
        />
        <span class="caption">{photo.title}</span>
      </a>
    ))}
  </div>
)}

<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox';
  import 'photoswipe/style.css';

  const lightbox = new PhotoSwipeLightbox({
    gallery: '#gallery',
    children: 'a',
    pswpModule: () => import('photoswipe'),
  });

  lightbox.init();
</script>

<style>
  .gallery {
    columns: 3;
    column-gap: 1rem;
  }

  @media (max-width: 768px) {
    .gallery { columns: 2; }
  }

  @media (max-width: 480px) {
    .gallery { columns: 1; }
  }

  .gallery-item {
    display: block;
    break-inside: avoid;
    margin-bottom: 1rem;
    position: relative;
    overflow: hidden;
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;
  }

  .gallery-item img {
    width: 100%;
    height: auto;
    border-radius: 6px;
    transition: transform 0.2s ease;
  }

  .gallery-item:hover img {
    transform: scale(1.02);
  }

  .caption {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.5rem 0.75rem;
    background: linear-gradient(transparent, rgba(0,0,0,0.6));
    color: #fff;
    font-size: 0.8rem;
    opacity: 0;
    transition: opacity 0.2s ease;
    border-radius: 0 0 6px 6px;
  }

  .gallery-item:hover .caption {
    opacity: 1;
  }

  .empty {
    color: var(--text-muted);
    font-style: italic;
  }
</style>
